#cloud-config
password: ubuntu
chpasswd:
  expire: False

# Tell cloud-init to log the output to a log file
output: {all: '| tee -a /var/log/cloud-init-output.log'}

# Set hostname
hostname: ubuntu

# Set timezone
timezone: US/Alaska

# Upgrade apt database on first boot
package_update: true

# Upgrade the instance on first boot
package_upgrade: true

packages:
 - rcs
 - nfs-common
 - awscli
 - mailutils
 - swish++
 - libio-captureoutput-perl
 - libcgi-pm-perl
 - libdbi-perl
 - libdbd-mysql-perl
 - php
 - php-gd
 - texlive
 - php-xml*
 - lynx
 - apache2-doc
 - libapache2-mod-perl2
 - libbsd-resource-perl
 - libapache2-reload-perl
 - apache2-suexec-custom
 - mariadb-client
 - mariadb-server
 - php-mysql
 - libapache2-mod-php
 - x11-apps
 - whois
 - libgtk2.0-0
 - plocate
 - php-mbstring
 - php-intl
 - php-apcu

ssh_import_is: [ubuntu]
ssh_authorized_keys:
 - ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAYEAnNqVrt71AKSIMmSAIONBx4jIEK0IIZF5fSAaB9kI4oOK+t7aSTKAZwwgKHWJ536XFdR3Ql5Xi0r2CuUEf1GVEagAxLZTXRuim5UGmS63rfSxGwq9JQVg5WDbN5ilnGxSmqsD77SApvmffcO/T2zZWd+rrjMWWRi9zQwRdQRm60bc69ajJbjIJd8SCXIggUPzTkUz5Sca7dhdffcMpGR9bdexFln+YSli1ohtvs2zVBM4ncpufGS+Auax8+gQNr32QeSszlKuKsXYorZ9gl+Z8s62mX5yCXIrH2hWoHsCTUX38iVM8/wI6sPVosarkng7mPOOQLy5k50Y0cb9FRQGlrvmQqsc3fI7tC1fblhKL0HaY844kIZRHwFuOI04ik+b8Swdjed6+FH/RIKppuOY+qfdmv8gcX4ZhpbKg+JN+u5Xy5awpUFqhsbBdCz0MvLNPKEbDNCFokX8nL0HqGeABk2DOJ1+IOFz5pIiCL31LTVGTQ0AwXp3nkaHZykJNrcB Authentication from lam@laptop.lam1.us

runcmd:
 - echo
 - echo 'QEMU LAM Alaska Allow any to read /var/log/cloud-init-output.log'
 - chmod a+r /var/log/cloud-init-output.log
 - echo
 - echo 'QEMU LAM Alaska Report user-data for this instance (CloudInit directives)'
 - echo
 - cat /var/lib/cloud/instances/lam0/user-data.txt
 - echo
 - echo 'QEMU LAM Alaska Set git user name, email for system'
 - git config --system user.name "LAMurakami"
 - git config --system user.email GitHub@LAMurakami.com
 - git config --system core.editor vi
 - git config --system branch.autosetuprebase always
 - git config --system init.defaultBranch master
 - echo
 - echo 'QEMU LAM Alaska Install etckeeper to track configuration changes'
 - apt-get install etckeeper
 - echo
 - echo 'QEMU LAM Alaska Adding nfs4 mount to ak20:/mnt/ak20-ext4 and ak20:/mnt/ak20-Bk'
 - mkdir /mnt/ak20-ext4 /mnt/ak20-Bk
 - echo "10.55.5.20:/mnt/ak20-ext4  /mnt/ak20-ext4  nfs4   defaults,nofail,x-systemd.device-timeout=4    0     0" >> /etc/fstab
 - echo "10.55.5.20:/mnt/ak20-Bk    /mnt/ak20-Bk    nfs4   defaults,nofail,x-systemd.device-timeout=4    0     0" >> /etc/fstab
 - mount -a -t nfs4
 - echo
 - echo 'QEMU LAM Alaska Adding a swapfile'
 - dd if=/dev/zero of=/swapfile bs=32M count=8
 - chmod 600 /swapfile
 - mkswap /swapfile
 - swapon /swapfile
 - echo "/swapfile swap swap defaults 0 0" >> /etc/fstab
 - echo
 - echo 'QEMU LAM Alaska Installing GNU which v2.21 compiled for Ubuntu Server 22.04'
 - tar -xzf /mnt/ak20-Bk/Bk2/aws/efs/aws-lam1-ubuntu/which-Ubuntu-22-04.tgz --directory /usr/local
 - file /usr/local/bin/which
 - echo
 - echo 'QEMU LAM Alaska Installing GNU tnef 1.4.18 compiled for Ubuntu Server 22.04'
 - tar -xzf /mnt/ak20-Bk/Bk2/aws/efs/aws-lam1-ubuntu/tnef-Ubuntu-22-04.tgz --directory /usr/local
 - file /usr/local/bin/tnef
 - echo
 - echo 'QEMU LAM Alaska Installing aws.lam1.us web site'
 - git clone /mnt/ak20-Bk/Bk2/ak20/home/git/aws /var/www/aws
 - sh -c "cd /var/www/aws;git remote set-url origin git@github.com:LAMurakami/aws"
 - sh -c "cd /var/www/aws;git remote add ak20 git@ak20:aws"
 - echo
 - echo 'QEMU LAM Alaska Cloud Guest motd'
 - ln -s /var/www/aws/etc/update-motd.d/51-cloudguest /etc/update-motd.d
 - echo
 - echo 'QEMU LAM Alaska Listen for ssh connections on alternate port 55520 and add ssh Banner'
 - cp /mnt/ak20-Bk/Bk2/aws/efs/aws-lam1-ubuntu/sshd_config /etc/ssh
 - ln -s /var/www/aws/etc/ssh/Banner.txt /etc/ssh
 - systemctl restart sshd
 - echo
 - echo 'QEMU LAM Alaska Check US Alaska local time for this system'
 - ls -lF --time-style=long-iso /etc/localtime
 - echo
 - echo 'QEMU LAM Alaska Installing ubuntu user bash resources'
 - tar -xzf /mnt/ak20-Bk/Bk2/aws/efs/aws-lam1-ubuntu/ubuntu.tgz --directory /home/ubuntu
 - echo
 - echo 'QEMU LAM Alaska Set ubuntu as owner of /var/www'
 - chown -R ubuntu:www-data /var/www
 - echo
 - echo 'QEMU LAM Alaska Final Cloud-init etckeeper commit'
 - etckeeper commit -m 'QEMU LAM Alaska Final Cloud-init etckeeper commit'
 - echo
 - echo 'QEMU LAM Alaska List Installed Packages information'
 - dpkg -l
 - echo
 - echo 'AWS LAM cloud-init complete'
 - echo
