#cloud-config
# user-data - qemu repo - opensuse branch - openSUSE Leap 15.6
# https://gitlab.com/aws-lam/qemu/-/blob/opensuse/user-data?ref_type=heads
# https://gitlab.com/aws-lam/qemu/-/blob/opensuse/meta-data?ref_type=heads

password: opensuse
chpasswd:
  expire: False

# Tell cloud-init to log the output to a log file
output: {all: '| tee -a /var/log/cloud-init-output.log'}

# Set hostname
hostname: opensuse

# Set timezone
timezone: US/Alaska

ssh_authorized_keys:
 - ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAYEAnNqVrt71AKSIMmSAIONBx4jIEK0IIZF5fSAaB9kI4oOK+t7aSTKAZwwgKHWJ536XFdR3Ql5Xi0r2CuUEf1GVEagAxLZTXRuim5UGmS63rfSxGwq9JQVg5WDbN5ilnGxSmqsD77SApvmffcO/T2zZWd+rrjMWWRi9zQwRdQRm60bc69ajJbjIJd8SCXIggUPzTkUz5Sca7dhdffcMpGR9bdexFln+YSli1ohtvs2zVBM4ncpufGS+Auax8+gQNr32QeSszlKuKsXYorZ9gl+Z8s62mX5yCXIrH2hWoHsCTUX38iVM8/wI6sPVosarkng7mPOOQLy5k50Y0cb9FRQGlrvmQqsc3fI7tC1fblhKL0HaY844kIZRHwFuOI04ik+b8Swdjed6+FH/RIKppuOY+qfdmv8gcX4ZhpbKg+JN+u5Xy5awpUFqhsbBdCz0MvLNPKEbDNCFokX8nL0HqGeABk2DOJ1+IOFz5pIiCL31LTVGTQ0AwXp3nkaHZykJNrcB Authentication from lam@laptop.lam1.us

packages:
 - git
 - rcs
 - nfs-kernel-server
 - aws-cli
 - php8
 - php8-gd
 - lynx
 - apache2-manual
 - apache2-mod_perl
 - mariadb-client
 - mariadb
 - php8-mysql
 - apache2-mod_php8
 - whois
 - gtk2-devel
 - mlocate
 - php8-mbstring
 - php8-intl
 - php8-APCu
 - leafpad
 - vim
 - man
 - xauth
 - perl-CGI
 - perl-DBI
 - perl-DBD-mysql
 - php8-ctype
 - php8-iconv
 - php8-fileinfo
 - libXmu6
 - libxkbfile1
 - libXaw7

runcmd:
 - keyName="qemu-lam-opensuse"
 - echo
 - echo 'QEMU LAM Alaska Allow any to read /var/log/cloud-init-output.log'
 - chmod a+r /var/log/cloud-init-output.log
 - echo
 - echo 'QEMU LAM Alaska Report user-data for this instance (CloudInit directives)'
 - echo
 - cat /var/lib/cloud/instances/lam0/user-data.txt
 - echo
 - echo 'QEMU LAM Alaska Set git user name, email for system'
 - git config --system user.name "LAMurakami"
 - git config --system user.email GitHub@LAMurakami.com
 - git config --system core.editor vi
 - git config --system branch.autosetuprebase always
 - git config --system init.defaultBranch master
 - git config --system core.pager "less --quit-if-one-screen --no-init"
 - echo
 - echo 'QEMU LAM link which to /usr/local/bin *****'
 - ln -s /usr/bin/which /usr/local/bin/which
 - echo
 - echo 'QEMU LAM Alaska Adding a swap partition'
 - echo '/dev/sdb1 swap swap defaults 0 0' >> /etc/fstab
 - swapon --all
 - free
 - swapon -s
 - echo
 - echo 'QEMU LAM Alaska Install etckeeper to track configuration changes'
 - zypper --non-interactive install etckeeper
 - echo
 - echo 'QEMU LAM Alaska Install texlive after swap is enabled'
 - zypper --non-interactive install texlive
 - echo
 - echo 'QEMU LAM Initialize etckeeper'
 - etckeeper init
 - etckeeper commit -m 'QEMU LAM Initial Cloud-init commit'
 - echo
 - echo 'QEMU LAM enable and start MariaDB'
 - systemctl enable mariadb
 - systemctl start mariadb
 - echo
 - echo 'QEMU LAM Set hostname and localhost alias in /etc/hosts'
 - sed -i '12s/localhost/opensuse.lam1.us opensuse localhost/' /etc/hosts
 - echo '192.168.0.20 ak20.lam1.us ak20' >> /etc/hosts
 - echo
 - echo 'QEMU LAM Add localhost to known_hosts'
 - ssh-keyscan -t ed25519 localhost >> /etc/ssh/ssh_known_hosts
 - echo
 - echo 'QEMU LAM Create logs/ sybmolic link for Apache2 configuration use'
 - ln -s /var/log/apache2 /srv/www/logs
 - echo
 - echo 'QEMU LAM Alaska Installing aws.lam1.us web site'
 - git clone https://github.com/LAMurakami/aws /var/www/aws
 - sh -c "cd /var/www/aws;git remote set-url origin git@github.com:LAMurakami/aws"
 - sh -c "cd /var/www/aws;git remote rename origin github"
 - sh -c "cd /var/www/aws;git remote add aws git@aws:aws"
 - sh -c "cd /var/www/aws;git remote add gitlab git@gitlab.com:aws-lam/aws"
 - sh -c "cd /var/www/aws;git checkout -b $keyName"
 - sh -c "cd /var/www/aws;git tag -a -m 'QEMU LAM Initialization' b0-$keyName"
 - echo
 - echo 'QEMU LAM Alaska Cloud Guest motd'
 - ln -s /var/www/aws/etc/update-motd.d/51-cloudguest /etc/update-motd.d
 - echo
 - echo 'QEMU LAM Alaska Check US Alaska local time for this system'
 - ls -lF --time-style=long-iso /etc/localtime
 - echo
 - echo 'QEMU LAM Alaska Installing gci.lam1.us web site'
 - git clone https://github.com/LAMurakami/gci /var/www/gci
 - sh -c "cd /var/www/gci;git remote set-url origin git@github.com:LAMurakami/gci"
 - sh -c "cd /var/www/gci;git remote rename origin github"
 - sh -c "cd /var/www/gci;git remote add aws git@aws:gci"
 - sh -c "cd /var/www/gci;git remote add gitlab git@gitlab.com:aws-lam/gci"
 - sh -c "cd /var/www/gci;git checkout -b $keyName"
 - sh -c "cd /var/www/gci;git tag -a -m 'QEMU LAM Initialization' b0-$keyName"
 - echo
 - echo 'QEMU LAM Installing no-ssl Apache configuration'
 - git clone https://github.com/LAMurakami/no-ssl /var/www/no-ssl
 - sh -c "cd /var/www/no-ssl;git remote set-url origin git@github.com:LAMurakami/no-ssl"
 - sh -c "cd /var/www/no-ssl;git remote rename origin github"
 - sh -c "cd /var/www/no-ssl;git remote add aws git@aws:no-ssl"
 - sh -c "cd /var/www/no-ssl;git remote add gitlab git@gitlab.com:aws-lam/no-ssl"
 - sh -c "cd /var/www/no-ssl;git checkout -b $keyName"
 - sh -c "cd /var/www/no-ssl;git tag -a -m 'QEMU LAM Initialization' b0-$keyName"
 - a2enmod mod_perl
 - a2enmod rewrite
 - echo
 - echo 'QEMU LAM Alaska Installing z.lam1.us web site (for /About/Public)'
 - git clone https://github.com/LAMurakami/z /var/www/z
 - sh -c "cd /var/www/z;git remote set-url origin git@github.com:LAMurakami/z"
 - sh -c "cd /var/www/z;git remote rename origin github"
 - sh -c "cd /var/www/z;git remote add aws git@aws:z"
 - sh -c "cd /var/www/z;git remote add gitlab git@gitlab.com:aws-lam/z"
 - sh -c "cd /var/www/z;git checkout -b $keyName"
 - sh -c "cd /var/www/z;git tag -a -m 'QEMU LAM Initialization' b0-$keyName"
 - echo
 - echo 'QEMU LAM Alaska Installing sites.lam1.us web site (for /About/Public)'
 - git clone https://github.com/LAMurakami/sites /var/www/sites
 - sh -c "cd /var/www/sites;git remote set-url origin git@github.com:LAMurakami/sites"
 - sh -c "cd /var/www/sites;git remote rename origin github"
 - sh -c "cd /var/www/sites;git remote add aws git@aws:sites"
 - sh -c "cd /var/www/sites;git remote add gitlab git@gitlab.com:aws-lam/sites"
 - sh -c "cd /var/www/sites;git checkout -b $keyName"
 - sh -c "cd /var/www/sites;git tag -a -m 'QEMU LAM Initialization' b0-$keyName"
 - echo
 - echo 'QEMU LAM Configuring perl to include LAM perl modules'
 - ln -s /var/www/no-ssl/site_perl-LAM /usr/lib/perl5/site_perl/LAM
 - echo
 - echo 'QEMU LAM Enable x11 forwarding over ssh for sudo'
 - ln -s /var/www/no-ssl/xauthority.sh /etc/profile.d
 - echo
 - echo 'QEMU LAM ***** Use private LAM Alaska resources *****'
 - echo
 - echo 'QEMU LAM Alaska Adding nfs4 mount to ak20:/mnt/ak20-ext4 and ak20:/mnt/ak20-Bk'
 - mkdir /mnt/ak20-ext4 /mnt/ak20-Bk
 - echo "ak20:/mnt/ak20-ext4  /mnt/ak20-ext4  nfs4   defaults,nofail,x-systemd.device-timeout=4    0     0" >> /etc/fstab
 - echo "ak20:/mnt/ak20-Bk    /mnt/ak20-Bk    nfs4   defaults,nofail,x-systemd.device-timeout=4    0     0" >> /etc/fstab
 - mount -a -t nfs4
 - df -Th --exclude-type=tmpfs --exclude-type=devtmpfs
 - echo
 - echo 'QEMU LAM Alaska Listen for ssh connections on alternate port 55520 and add ssh Banner'
 - cp /mnt/ak20-Bk/Bk2/aws/efs/aws-lam1-ubuntu/sshd_config /etc/ssh
 - ln -s /var/www/aws/etc/ssh/Banner.txt /etc/ssh
 - systemctl restart sshd
 - echo
 - echo 'QEMU LAM configure aws-lam IPv4 access including IPv6 tunnels'
 - cp /var/www/aws/etc/ssh/ssh_config.d/aws-lam.conf /etc/ssh/ssh_config.d
 - cp /var/www/aws/etc/profile.d/ssh_tunnel.sh /etc/profile.d
 - echo
 - echo 'QEMU LAM Install man2html'
 - tar -xzf /mnt/ak20-ext4/Install/QEMU/opensuse/openSUSE-15-man2html.tgz --directory /usr/local
 - echo
 - echo 'QEMU LAM Install xeyes'
 - tar -xzf /mnt/ak20-ext4/Install/QEMU/opensuse/openSUSE-15-xeyes.tgz --directory /usr/local
 - ln -s /usr/local/bin/xeyes /bin/xeyes
 - echo
 - echo 'QEMU LAM Install xclock'
 - tar -xzf /mnt/ak20-ext4/Install/QEMU/opensuse/openSUSE-15-xclock.tgz --directory /usr
 - ln -s /usr/local/bin/xclock /bin/xclock
 - echo
 - echo 'QEMU LAM Install xlogo'
 - tar -xzf /mnt/ak20-ext4/Install/QEMU/opensuse/openSUSE-15-xlogo.tgz --directory /usr
 - ln -s /usr/local/bin/xlogo /bin/xlogo
 - echo
 - echo 'QEMU LAM Alaska Installing ubuntu user bash resources'
 - tar -xzf /mnt/ak20-Bk/Bk2/aws/efs/aws-lam1-ubuntu/ubuntu.tgz --directory /home/opensuse
 - echo
 - echo 'QEMU LAM Link to .aws resources for root'
 - ln -s /home/opensuse/.aws /root/.aws
 - echo
 - echo 'QEMU LAM ***** Secure site *****'
 - echo
 - echo 'QEMU LAM Alaska Second Cloud-init etckeeper commit'
 - etckeeper commit -m 'QEMU LAM Alaska Second Cloud-init etckeeper commit'
 - echo
 - echo 'QEMU LAM Installing Let-s Encrypt certificates for TLS encryption (HTTPS)'
 - tar -xzf /mnt/ak20-Bk/Bk2/aws/efs/aws-lam1-ubuntu/letsencrypt.tgz --directory /etc
 - echo
 - echo 'QEMU LAM Alaska Let-s Encrypt certificates etckeeper commit'
 - etckeeper commit -m 'QEMU LAM Alaska Second Let-s Encrypt certificates etckeeper commit'
 - echo
 - echo 'QEMU LAM Updating apache2 configuration for lam1'
 - a2enmod info
 - a2enmod authz_groupfile.load
 - a2enflag SSL
 - a2enflag STATUS
 - echo
 - echo 'QEMU LAM Tell git installing in /var/www/lam is O.K.'
 - git config --system --add safe.directory /var/www/lam
 - echo
 # Extract lam from archive that includes MediWiki
 - tar -xzf /mnt/ak20-Bk/Bk2/aws/efs/lam.tgz --directory /var/www
 # Use opensuse branch to serve secure site at https://opensuse.lam1.us
 - sh -c "cd /var/www/lam;git stash"
 - sh -c "cd /var/www/lam;git checkout opensuse"
 - sh -c "cd /var/www/lam;git checkout -b $keyName"
 - sh -c "cd /var/www/lam;git tag -a -m 'QEMU LAM Initialization' b0-$keyName"
 - echo
 - echo 'QEMU LAM Configure /server-info and /server-status'
 - rm /etc/apache2/mod_info.conf
 - ln -s /var/www/lam/lam_info.conf /etc/apache2/mod_info.conf
 - rm /etc/apache2/mod_status.conf
 - ln -s /var/www/lam/lam_status.conf /etc/apache2/mod_status.conf
 - a2enmod mod_status
 - echo
 - echo 'QEMU LAM Setup openSuSE default server configuration'
 - rm /etc/apache2/default-server.conf
 - cp /var/www/lam/apache2.conf /etc/apache2/default-server.conf
 - echo
 - echo 'QEMU LAM Create lam murakami staff credentials.'
 - /var/www/lam/Create-lam-murakami-staff.bash
 - echo
 - echo 'QEMU LAM Create git user'
 - useradd -g staff -G staff -M -d /mnt/ak20-Bk/Bk2/aws/efs/git -u 4896 git
 - echo
 - echo 'QEMU LAM Create Multicount directory'
 - mkdir /var/www/Multicount
 - chown wwwrun:www /var/www/Multicount
 - chmod 775 /var/www/Multicount
 - echo
 - echo 'QEMU LAM Creating {lam|Mediawiki} database and user'
 - mysql --table < /var/www/lam/lam-user.sql
 - echo
 - echo 'QEMU LAM ***** Final Initialization Steps *****'
 - echo
 - echo 'QEMU LAM Install gitweb after apache has been configured'
 - zypper --non-interactive install git-web
 - sed -i '1 s|Alias /git "/usr/share/gitweb/"|Alias /gitweb "/usr/share/gitweb/"|' /etc/apache2/conf.d/gitweb.conf
 - cp /var/www/aws/etc/gitweb.conf /etc/gitweb.conf
 - sed -i "s|/mnt/efs/git|/mnt/ak20-Bk/Bk2/aws/efs/git/|g" /etc/gitweb.conf
 - echo
 - echo 'QEMU LAM Activate aws and additional sites'
 - /var/www/aws/qemu-lam-apache2-sites-configuration-OpenSUSE.bash
 - echo
 - echo 'QEMU LAM Alaska Set lam as owner of /var/www'
 - chown -R lam:www /var/www
 - echo
 - echo 'QEMU LAM Refreshing lam database'
 - aws s3 cp s3://lamurakami/Bk-20-MySQL.lam.sql.gz - | gunzip -c | mysql --user=lam lam
 - aws s3 cp s3://lamurakami/Bk-20-MySQL.wikidb.sql.gz - | gunzip -c | mysql --user=lam wikidb
 - echo
 - echo 'QEMU LAM Update all packages replacing files if necessary'
 - zypper --non-interactive update --replacefiles
 - echo
 - echo 'QEMU LAM enable and start apache2'
 - systemctl enable apache2
 - systemctl start apache2
 - echo
 - echo 'QEMU LAM ***** Update mlocate database *****'
 - updatedb
 - echo
 - echo 'QEMU LAM Alaska Final Cloud-init etckeeper commit'
 - etckeeper commit -m 'QEMU LAM Alaska Final Cloud-init etckeeper commit'
 - echo
 - echo 'QEMU LAM Alaska List Installed Packages information'
 - zypper search -i
 - echo
 - echo 'QEMU LAM report reboot hint'
 - zypper ps -s
 - echo
 - echo 'QEMU LAM cloud-init complete'
 - echo
